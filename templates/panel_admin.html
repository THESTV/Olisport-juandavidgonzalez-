<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Panel Admin | OliSport" />

    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" crossorigin="anonymous" />

    <!-- Bootstrap solo para modales -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-responsive.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />

    <title>Panel de Administración | OliSport</title>
</head>

<body>

<!-- ========================================================= -->
<!-- NAVBAR -->
<!-- ========================================================= -->
<header>
    <nav class="navbar">
        <div class="nav-container">

            <div class="logo-area">
                <a href="{{ url_for('index') }}" class="logo">
                    <img src="{{ url_for('static', filename='img/portfolio/logo-olisport.PNG') }}" alt="logo">
                </a>

                <div class="auth-icons">
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('logout') }}" class="icon-btn" title="Cerrar sesión">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="icon-btn">
                            <i class="fas fa-user"></i>
                        </a>
                    {% endif %}
                </div>
            </div>

            <ul class="nav-links">
                <li><a href="{{ url_for('index') }}">Inicio</a></li>
                <li><a href="{{ url_for('market') }}">Market</a></li>

                {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('perfil') }}">Mi Perfil</a></li>

                    {% if current_user.rol in ['trabajador','admin'] %}
                        <li><a href="{{ url_for('panel_trabajador') }}"><i class="fas fa-tools"></i></a></li>
                    {% endif %}

                    {% if current_user.rol == 'admin' %}
                        <li><a href="{{ url_for('panel_admin') }}" class="current"><i class="fas fa-crown"></i></a></li>
                    {% endif %}
                {% endif %}
            </ul>

            <div class="hamburger" id="hamburger">☰</div>

            <div class="hamburger-menu" id="hamburgerMenu">
                <a href="{{ url_for('about') }}">Quiénes somos</a>
                <a href="{{ url_for('servicio') }}">Servicios</a>
                <a href="{{ url_for('contact') }}">Contáctanos</a>
            </div>

            <hr />
        </div>
    </nav>
</header>


<!-- ========================================================= -->
<!-- BANNER -->
<!-- ========================================================= -->
<main>

<section class="banner-header-p1-index">
    <div class="banner-header">
        <div class="banner-header-text">
            <h1 class="banner-title-admin">Panel de <span>Administración</span></h1>

            <div class="text-description-index">
                <hr />
                <p>
                    Bienvenido <strong>{{ usuario.nombre }}</strong>.  
                    Aquí puedes gestionar usuarios, roles y whitelist.
                </p>
            </div>
        </div>
    </div>
</section>


<!-- ========================================================= -->
<!-- USUARIOS REGISTRADOS -->
<!-- ========================================================= -->
<section class="section Catalogo">
    <div class="container-catalogo">
        <h3 class="title">USUARIOS REGISTRADOS</h3>
    </div>
</section>

<section>
    <div class="admin-card">

<table class="tabla-usuarios">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th></th>
            <th>Dirección</th>
            <th>Rol</th>
            <th>Whitelist</th>
            <th class="acciones-th">Acciones</th>
        </tr>
    </thead>

    <tbody>
    {% for u in usuarios %}
        {% set es_admin_principal = (u.correo == "admin@olisport.com") %}

        <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.nombre }}</td>
            <td>{{ u.correo }}</td>
            <td></td>
            <td>{{ u.direccion or "—" }}</td>

            <td>
                {% if u.rol == "admin" %}
                    <span class="badge admin">Admin</span>
                {% elif u.rol == "trabajador" %}
                    <span class="badge trabajador">Trabajador</span>
                {% else %}
                    <span class="badge usuario">Usuario</span>
                {% endif %}
            </td>

            <td>
                {% if u.whitelist %}
                    <span class="badge ok">Autorizado ✔</span>
                {% else %}
                    <span class="badge no">No autorizado</span>
                {% endif %}
            </td>

            <td class="acciones-td">

                {% if not es_admin_principal %}
                    {% if u.whitelist %}
                        <a href="{{ url_for('desautorizar_usuario', id_usuario=u.id) }}"
                           class="btn rojo small">Quitar autorización</a>
                    {% else %}
                        <a href="{{ url_for('autorizar_usuario', id_usuario=u.id) }}"
                           class="btn verde small">Autorizar</a>
                    {% endif %}
                {% endif %}

                <button class="btn azul small"
                        data-bs-toggle="modal"
                        data-bs-target="#modalEditar{{u.id}}">
                    Editar
                </button>

                {% if not es_admin_principal %}
                <form action="{{ url_for('eliminar_usuario', id_usuario=u.id) }}" method="POST"
                      onsubmit="return confirm('¿Seguro que quieres eliminar este usuario?');">
                    <button class="btn rojo small">Eliminar</button>
                </form>
                {% endif %}

            </td>
        </tr>

        <!-- ======================================== -->
        <!-- MODAL EDITAR -->
        <!-- ======================================== -->
        <div class="modal fade" id="modalEditar{{u.id}}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">

              <div class="modal-header">
                <h5 class="modal-title">Editar Usuario #{{u.id}}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>

<form action="{{ url_for('editar_usuario', id_usuario=u.id) }}" method="POST">
    <div class="modal-body">

        <label>Nombre:</label>
        <input type="text" name="nombre" class="form-control" value="{{u.nombre}}" required>

        <label class="mt-2">Correo:</label>
        <input type="email" name="correo" class="form-control" value="{{u.correo}}" required>

        <label class="mt-2">Dirección:</label>
        <input type="text" name="direccion" class="form-control" value="{{u.direccion}}">

        <!-- NUEVO: CAMBIAR ROL -->
        <label class="mt-2">Rol:</label>
        <select name="rol" class="form-control" required>
            <option value="usuario"   {% if u.rol == 'usuario' %}selected{% endif %}>Usuario</option>
            <option value="trabajador" {% if u.rol == 'trabajador' %}selected{% endif %}>Trabajador</option>
            <option value="admin"     {% if u.rol == 'admin' %}selected{% endif %}>Administrador</option>
        </select>

        <label class="mt-2">Nueva contraseña (opcional):</label>
        <input type="password" name="password" class="form-control"
               placeholder="Deja vacío para no cambiar">

    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar cambios</button>
    </div>
</form>

            </div>
          </div>
        </div>

    {% endfor %}
    </tbody>
</table>

    </div>
</section>


<!-- ========================================================= -->
<!-- DIVISIÓN ENTRE MÓDULOS -->
<!-- ========================================================= -->
<div class="section-divider"></div>


<!-- ========================================================= -->
<!-- CREAR NUEVO USUARIO -->
<!-- ========================================================= -->
<section class="section Catalogo">
    <div class="container-catalogo">
        <h3 class="title">CREAR NUEVO USUARIO</h3>
    </div>
</section>

<section>
    <div class="admin-card">

<form action="{{ url_for('crear_usuario') }}" method="POST" class="form-crear-modern">

    <div class="field">
        <label><i class="fas fa-user"></i> Nombre completo</label>
        <input type="text" name="nombre" placeholder="Ej: Ana Martínez" required>
    </div>

    <div class="field">
        <label><i class="fas fa-envelope"></i> Correo electrónico</label>
        <input type="email" name="correo" placeholder="usuario@correo.com" required>
    </div>

    <div class="field">
        <label><i class="fas fa-map-marker-alt"></i> Dirección</label>
        <input type="text" name="direccion" placeholder="Opcional">
    </div>

    <div class="field">
        <label><i class="fas fa-lock"></i> Contraseña</label>
        <input type="password" name="password" placeholder="Si no escribes una → será 12345">
    </div>

    <div class="field">
        <label><i class="fas fa-user-tag"></i> Rol del usuario</label>
        <select name="rol" required>
            <option value="" disabled selected>Selecciona el rol</option>
            <option value="usuario">Usuario</option>
            <option value="trabajador">Trabajador</option>
            <option value="admin">Administrador</option>
        </select>
    </div>

    <button type="submit" class="btn verde btn-crear-modern">
        <i class="fas fa-plus-circle"></i> Crear Usuario
    </button>
</form>

    </div>
</section>


</main>


<!-- ========================================================= -->
<!-- FOOTER -->
<!-- ========================================================= -->
<footer class="main-footer">
    <p>&copy; 2025 OliSport — Todos los derechos reservados.</p>
    <div class="container">
        <p class="small">Panel de Administración</p>
        <ul>
            <li><a href="#"><i class="fab fa-facebook"></i></a></li>
            <li><a href="#"><i class="fab fa-instagram"></i></a></li>
            <li><a href="#"><i class="fab fa-youtube"></i></a></li>
        </ul>
    </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.getElementById("hamburger").addEventListener("click", function () {
        const menu = document.getElementById("hamburgerMenu");
        menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    });
</script>

</body>
</html>
